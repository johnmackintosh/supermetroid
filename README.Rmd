---
output: 
  github_document:
    toc: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  # cache = TRUE, # does this always cause an error?
  error = TRUE,
  echo=FALSE,
  message=FALSE,
  warning=FALSE,
  fig.align = 'center'
)

# put next to heading when have logo
# <img src="man/figures/Smetroidbox-wiki.png" align="right" />

```

# supermetroid 

<!-- badges: start -->
<!-- badges: end -->

This packaged analysis accompanies [PyData Copenhagen June 2023](https://www.meetup.com/pydata-copenhagen/events/294210771/). 

Super Metroid speed run data is captured from leaderboards, and analysed to answer the following question, posed by `anatomecha`, a Super Metroid speed runner. 

> At what times do Super Metroid 100% speed runs get competitive?

# What is Super Metroid?

> While the exploration-focused platformers known as Metroidvanias derive their genre name from two different series, there’s one game they’re all judged by. Super Metroid wasn’t the first Metroidvania, the first Metroid game also had the focus on exploring a large interconnected map and using new abilities to open up new areas, but its polish, visual direction, and atmosphere all created a more involved experience than its predecessors. Released in 1994, Super Metroid’s shadow looms over every game in the genre since... - [thegamehoard 2022](https://thegamehoard.com/2022/04/24/50-years-of-video-games-super-metroid-snes/) 


```{r fig.align='center', out.width="50%",fig.cap="source: wikipedia"}
# source: wikipedia
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/en/e/e4/Smetroidbox.jpg")

```

## Super Metroid speed running

As part of the verification of their speed run results, many players upload a [video of the run](https://www.youtube.com/embed/7-cj22T2Yu4) to youtube.

<iframe width="560" height="315" src="https://www.youtube.com/embed/hNglm3KxCHQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

This analysis focuses on 100% speedruns wherein players traverse a map using different routes to collect all loot and defeat all bosses. Speed runners try to do this as fast as possible, and log their results on leaderboards such as [speedrun.com](https://www.speedrun.com/supermetroid?h=100&x=xd1mpewd) or splitsio.  

A core feature of the game is that there are many routes through the map. These routes are often hidden in seemingly impassable walls, or require solving a puzzle. 

```{r fig.cap="image source: metroid.retropixel.net"}
knitr::include_graphics("https://metroid.retropixel.net/games/metroid3/metroid3_map.gif")

```

Speed runners hone their skills by mastering techniques to improve their speed in collecting all loot and defeating all bosses in a 100% run through the game. 

In addition to ranking data from [speedrun.com](https://speedrun.com/)'s leaderboards, this analysis incorporates timepoints observed for game events (of the player's choosing, frustratingly). 

Speed runners use this open source plugin for the open source emulator favoured by SNES Super Metroid (1994) speed runners. These observations are captured in a .lss file that can be uploaded to [splitsio](https://splits.io/).  


```{r out.width="40%"}
knitr::include_graphics("vignettes/splits_screenshot.PNG")
```

### Open Python speed runner API implementations

Jeremy Silver maintains a Python implentation [`splitsio`](https://github.com/jeremander/splitsio) of the [REST API](https://github.com/glacials/splits-io/blob/master/docs/api.md) that provides players' timepoint observations of game events from [splitsio](https://splits.io/). @jeremander's consultation on this analysis provided key answers to questions of [what was and was not possible with the data](https://github.com/jeremander/splitsio/issues/1).     

Player ranks from speedrun.com were accessed via the Python implementation [`srcomapi`](https://github.com/blha303/srcomapi) of the [REST API](https://github.com/speedruncomorg/api) for [speedrun.com](https://speedrun.com/). 

# Analyses (work in progress)

## Colour palette is in experimental/grab whatever colours phase

<div class="tenor-gif-embed" data-postid="10436793" data-share-method="host" data-aspect-ratio="1.3369" data-width="100%"><a href="https://tenor.com/view/no-sir-i-dont-like-it-horse-gif-10436793">No Sir I Dont Like It GIF</a>from <a href="https://tenor.com/search/no+sir-gifs">No Sir GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>

```{r message=FALSE}
# R packages
library(supermetroid) # analysis code
library(tidyverse) # data science tools
library(knitr) # for html tables
library(ggraph) # graphs
library(tidygraph) # graphs


data("src_df")
data("from_to_df")

```

### Vignettes

Vignette|Description|Output data
-|-
data schema | Plan for what data to extract for analysis |
player-rank | Combine speedrun.com and splits.io data | `splits_df`
src | Scrape supermetroid.com data using `srcomapi` | `src_df`
sio | Scrape splits.io data using `splitsio`; data is not labelled in this vignette. Raw data. | `sio_splits_df`
splits | Use anatomecha's labels to update split strings | `sio_df`, `anatomecha_splist`, `sio_routes_wide`
route-matching | Explore the missingness of routes recorded by players | `distinct_routes`
route-graph | Graphs of routes players take | `from_to_df` 
identifying-routes | Classifying routes players take | 
player-locations | Exploring differences in players across locations | 

### Speed run times from speedrun.com

```{r }

all_run_raincloud(base_size = 15)

```

- [ ] interpretable x axis

```{r}
data("src_df")

top_100 <- src_df %>% 
  filter(rank <= 100) 

top_100 %>% 
  all_run_raincloud(xmin = min(top_100$t_s) / 60, xmax = max(top_100$t_s)/ 60, base_size =  15) +
  labs(title = "Top 100 Super Metroid 100% speed run times" %>% str_wrap(40))


```


### Where are Super Metroid players?

```{r}
sm_world()

```

## Routes players take

### Different routes

```{r}
cum_t_route_vis(base_size = 10)

```

### Missingness of routes

#### Exploratory graphs

```{r}
from_to_gg <- 
  from_to_df %>% 
  as_tbl_graph()

```

##### Too messy

```{r fig.width=8, fig.height=8}
from_to_gg %>% 
  ggraph() +
  geom_edge_fan(aes(size = runs))
  

```

##### Need order


```{r fig.width=8, fig.height=8}
from_to_gg %>%
  ggraph(layout = "linear", circular = TRUE) +
  geom_edge_fan(aes(size = runs), alpha = 0.2) +
  geom_node_point(aes(colour = ))


```


##### Need direction


```{r fig.width=8, fig.height=8}
from_to_gg %>%
  ggraph(layout = "linear") +
  geom_edge_fan(aes(size = runs), alpha = 0.2) +
  geom_node_point()


```

##### Too many nodes for EDA

```{r fig.width=8, fig.height=8} 
from_to_gg %>% 
  ggraph(layout = "linear") +
  geom_edge_arc(arrow = arrow(), aes(alpha = runs)) 


```


#### Analysis graph

```{r fig.width=8, fig.height=8}
route_graph(base_size = 15)


```


## All the runs

```{r}
ranked_runs("ice beam", base_size = 15)

```

```{r}
ranked_runs("grapple beam", base_size = 15)


```

```{r}

# restrict runs
ranked_runs("grapple beam", base_size = 15) +
  xlim(0.2, 0.6) +
  labs(
    x = "Time (hrs) restricted to most grapple beam observations" %>% 
      str_wrap()
  )


```


## Super Metroid and speed running



### Super Metroid is the top SNES speed runner game

```{r}
top_five_vis(base_size = 10)

```

- [ ] convert to coloured barchart, grouped by game, coloured by category
- [ ] how can we scrape these data?


### Subway Surfers TikTok phenomenon or good upload interface?

```{r }
top_games_vis(base_size = 10)
```




