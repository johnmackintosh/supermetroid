---
title: "sio"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sio}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error=TRUE
)
```

```{r setup, message=FALSE}
library(supermetroid)
library(tidyverse)
```

```{python}
import pandas as pd
import splitsio
```


# splits.io data

## Load runs and runners  

```{python}
# this chunk is not evaluated 
# to minimise api calls

# get 100% Category Super Metroid game data  
sio_cat = splitsio.Category.from_id("279", historic=True)
type(sio_cat)
```

This module has its own types. 


```{python load splitsio dat}
# extract runners from category  
sio_runners = sio_cat.runners()
type(sio_runners)
sio_runners[0]
sio_runners[-1]

# extract run from category
sio_runs = sio_cat.runs()
type(sio_runs)
sio_runs[0]
sio_runs[-1]
```

## Run dataframe

Objective: to wrangle a data frame with run data

sio_run_df | description | splitsio 
- | - | - 
*run_id* | splits.io id | `id` | 
date | timestamp of run upload | ? `'created_at', 'parsed_at', 'updated_at'` we'll use 'updated_at' for now, but should check splitsio docs for which
run_time | total time of run in s or ms | `realtime_duration_ms`
rank | "historical" if from previous record (nb only applies to speedrun.com); otherwise rank as int, list column | ?
src_player_id | speedrun.com player id | `srdc_id`

## Try with list of dictionaries

```{python}

# convert the run objects to disctionaries
sio_run_dicts = [sio_runs[x].to_dict() for x in range(len(sio_runs))]

# each element is a dictionary with keys
sio_run_dicts[0].keys()

```

```{python}
# run id
sio_run_dicts[0].keys()

# get id
sio_run_dicts[0]['id']

# get realtime
sio_run_dicts[0]['realtime_duration_ms']

```

```{python}
# player data
pd.json_normalize(sio_run_dicts[0]['runners'])['id'][0]

sio_run_player_index = 10 # len(sio_run_dicts)

run_runners_list = [pd.json_normalize(sio_run_dicts[x]['runners']).assign(run_id = sio_runs[x].id) for x in range(len(sio_runs))]

run_runners_concat = pd.concat(run_runners_list)

run_runners = run_runners_concat[['name', 'run_id','id']].rename(columns={'id':'player_id', 'name':'player_name'})

sio_run_dicts[0].keys()

# this



```

```{python}
# create a dataframe

sio_runs_df = pd.DataFrame({
  'run_id' : [sio_run_dicts[x]['id'] for x in range(len(sio_runs))],
  't_ms' : [sio_run_dicts[x]['realtime_duration_ms'] for x in range(len(sio_runs))],
  'date' : [sio_run_dicts[x]['updated_at'] for x in range(len(sio_runs))]
  # ,
 #  'image_url': [sio_run_dicts[x]['image_url'] for x in range(len(sio_runs))],
  # 'video_url': [sio_run_dicts[x]['video_url'] for x in range(len(sio_runs))]
})


sio_runs_df.head()


```

```{r}
# need to merge with run runners
run_runners.head()

sio_df = sio_runs_df.merge(run_runners, on = "run_id", how = 'left')


```



```{r}
# take a look 

py$sio_runs_df %>% select(-contains("url")) %>% 
  select(display_name, everything()) %>% sample_n()

# argh something is bad 

```



## create segments dataframe

segment_df | description
- | - 
*run_id* | unique identifier of run
segment_id | unique identifier of segment
t_s | time in seconds, measured to millisecond precision

```{python}
# first level of segments
type(sio_df['segments'][0])
len(sio_df['segments'][0])

# second level of segments
type(sio_df['segments'][0][0])
sio_df['segments'][0][2].keys()


segments_list = [pd.DataFrame(sio_df.segments[x]).assign(run_id = sio_df.id[x]) for x in range(sio_df.shape[0]) ]

segment_raw = pd.concat(segments_list)

segment_raw.columns
segment_raw.shape

sio_segments_df = segment_raw.merge(
  sio_runs_df[['player_name', 'player_id']], on = "run_id", how="left")


```

```{r}
# tidy it up in R before writing it

sio_segments <- py$sio_segments_df


sio_splits_df <- 
sio_segments %>% 
  select(
    player_name, 
    game_event = display_name, 
    segment_number, 
    realtime_start_ms, 
    segment_id = id,
    run_id,
    player_id,
    everything()) %>% 
  select(-contains("gametime"),
         -contains("reduced"),
         -contains("skipped"), -histories) %>% 
  mutate(
    player_id = as.character(player_id))

```

```{r eval=FALSE}
usethis::use_data(sio_splits_df)

```
